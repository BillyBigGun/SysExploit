#include <stdio.h>
#include <stdlib.h>
#include "utils.h"
#include <unistd.h>
#include <sys/wait.h>
#include <string.h>
#include <sys/mman.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <sys/types.h>
  

int main(int argc, char *argv[])
{
    int size = 1;
    int fd = shm_open("/file", O_CREAT | O_RDWR, S_IRUSR | S_IWUSR);
    ftruncate(fd, size*sizeof(int));

    void *ptr = mmap (NULL, size*sizeof(int), PROT_READ | 
    PROT_WRITE, MAP_SHARED, fd, 0);

    close(fd);

    if(ptr == MAP_FAILED){
        printf("Error mmap\n");
        exit(EXIT_FAILURE);
    }
    int* sharedData = (int*)(ptr);
    sharedData[0] = 0;

    int pid = fork();
    if(pid == 0){
        while(1){
            int val = sharedData[0];
            printf("Value = %d\n", val);
            sharedData[0] = val + 1;
            sleep(1);
        }

    }
    else{

        while(1){
            int val = sharedData[0];
            printf("Value = %d\n", val);
            sharedData[0] = val + 1;
            sleep(1);
        }
    
    }
    munmap(ptr, size*sizeof(int));
    return 1;
}