#include <stdio.h>
#include <stdlib.h>

#include <unistd.h>
#include <sys/wait.h>
#include <string.h>

#include "utils.h"


int main(int argc, char *argv[])
{
    int indice__ = argc;
    // On cherche l'indice du "--"
    for(int i = 0; i < argc; i++){
        if(argv[i] != "--")
        {
            indice__ = i;
        }
    }
    // On crée le pipe
    int fd[2];
    if(pipe(fd) == -1)
    {
        perror("pipe");
        exit(1);
    }

    char* command1 = argv[1];
    char* args1[indice__];
    for(int i = 1; i < indice__; i++)
    {
        args1[i-1] = argv[i];
    }
    args1[indice__-1] = NULL;

    char* command2 = argv[indice__+1];
    char* args2[argc-indice__];
    for(int i = indice__+1; i < argc; i++)
    {
        args2[i-indice__+1] = argv[i];
    }
    args2[argc-indice__+1] = NULL;

    // On crée les deux processus
    int pid1 = fork();
    if (pid1 ==0 )
    {
        // 
        close(fd[0]);
        dup2(fd[1], STDOUT_FILENO);
        execvp(argv[1], args1);

    }
    else
    {
        int pid2 = fork();
        if(pid2 == 0)
        {
            close(fd[1]);
            dup2(fd[0], STDIN_FILENO);
            //char buffer[512];
            //int status = read(fd[0], buffer, sizeof(buffer));
            //printf("status : %s\n", buffer);
            execvp(command2, args2);
            //perror("execvp error");
        }
        else
        {
            // Pere qui attend la fin des fils
            close(fd[0]);
            close(fd[1]);
            wait(NULL);
            wait(NULL);
        }
    }

    return EXIT_SUCCESS;
}
